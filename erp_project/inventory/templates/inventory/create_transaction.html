{% extends 'inventory/base.html' %}

{% block title %}Create Transaction - Pluviago ERP{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-plus me-2"></i>
        Create New Transaction
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'inventory:transaction_list' %}" class="btn btn-sm btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Transactions
        </a>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-edit me-2"></i>
                    Transaction Details
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="transactionForm">
                    {% csrf_token %}
                    
                    <div class="row">
                        <!-- Transaction Type -->
                        <div class="col-md-6 mb-3">
                            <label for="transaction_type" class="form-label">Transaction Type *</label>
                            <select class="form-select" id="transaction_type" name="transaction_type" required>
                                <option value="">Select Transaction Type</option>
                                {% for value, label in transaction_types %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Item Code -->
                        <div class="col-md-6 mb-3">
                            <label for="item_code" class="form-label">Item *</label>
                            <select class="form-select" id="item_code" name="item_code" required>
                                <option value="">Select Item</option>
                                {% for item in items %}
                                    <option value="{{ item.item_record_id }}" 
                                            data-uom="{{ item.unit_of_measure }}"
                                            data-category="{{ item.category }}">
                                        {{ item.item_record_id }} - {{ item.item_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Quantity -->
                        <div class="col-md-4 mb-3">
                            <label for="quantity" class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="quantity" name="quantity" 
                                   step="0.01" min="0" required>
                        </div>

                        <!-- Unit -->
                        <div class="col-md-4 mb-3">
                            <label for="unit" class="form-label">Unit *</label>
                            <select class="form-select" id="unit" name="unit" required>
                                <option value="">Select Unit</option>
                                {% for value, label in units %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Batch ID -->
                        <div class="col-md-4 mb-3">
                            <label for="batch_id" class="form-label">Batch ID</label>
                            <input type="text" class="form-control" id="batch_id" name="batch_id" 
                                   placeholder="Optional">
                        </div>

                        <!-- Supplier/Customer Section -->
                        <div class="col-12 mb-3">
                            <hr>
                            <h6>Supplier/Customer Information</h6>
                        </div>

                        <!-- Supplier Code (for incoming transactions) -->
                        <div class="col-md-6 mb-3" id="supplier_section" style="display: none;">
                            <label for="supplier_code" class="form-label">Supplier</label>
                            <select class="form-select" id="supplier_code" name="supplier_code">
                                <option value="">Select Supplier</option>
                                {% for supplier in suppliers %}
                                    <option value="{{ supplier.supplier_id }}">{{ supplier.supplier_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Recipient Code (for outgoing transactions) -->
                        <div class="col-md-6 mb-3" id="recipient_section" style="display: none;">
                            <label for="recipient_code" class="form-label">Customer/Recipient</label>
                            <select class="form-select" id="recipient_code" name="recipient_code">
                                <option value="">Select Customer</option>
                                {% for customer in customers %}
                                    <option value="{{ customer.customer_code }}">{{ customer.customer_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Invoice Information -->
                        <div class="col-md-6 mb-3" id="invoice_section" style="display: none;">
                            <label for="invoice_no" class="form-label">Invoice Number</label>
                            <input type="text" class="form-control" id="invoice_no" name="invoice_no">
                        </div>

                        <div class="col-md-6 mb-3" id="invoice_date_section" style="display: none;">
                            <label for="invoice_date" class="form-label">Invoice Date</label>
                            <input type="date" class="form-control" id="invoice_date" name="invoice_date">
                        </div>

                        <!-- Storage Information -->
                        <div class="col-12 mb-3">
                            <hr>
                            <h6>Storage Information</h6>
                        </div>

                        <!-- Storage Zone -->
                        <div class="col-md-6 mb-3">
                            <label for="storage_zone" class="form-label">Storage Zone</label>
                            <select class="form-select" id="storage_zone" name="storage_zone">
                                <option value="">Select Storage Zone</option>
                                {% for zone in storage_zones %}
                                    <option value="{{ zone.zone_id }}">{{ zone.zone_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Storage Location -->
                        <div class="col-md-6 mb-3">
                            <label for="storage_location" class="form-label">Storage Location</label>
                            <select class="form-select" id="storage_location" name="storage_location">
                                <option value="">Select Storage Location</option>
                            </select>
                        </div>

                        <!-- Dates -->
                        <div class="col-12 mb-3">
                            <hr>
                            <h6>Important Dates</h6>
                        </div>

                        <!-- Manufacturing Date -->
                        <div class="col-md-4 mb-3">
                            <label for="mfg_date" class="form-label">Manufacturing Date</label>
                            <input type="date" class="form-control" id="mfg_date" name="mfg_date">
                        </div>

                        <!-- Expiry Date -->
                        <div class="col-md-4 mb-3">
                            <label for="expiry_date" class="form-label">Expiry Date</label>
                            <input type="date" class="form-control" id="expiry_date" name="expiry_date">
                        </div>

                        <!-- Opened Date -->
                        <div class="col-md-4 mb-3">
                            <label for="opened_date" class="form-label">Opened Date</label>
                            <input type="date" class="form-control" id="opened_date" name="opened_date">
                        </div>

                        <!-- Comments -->
                        <div class="col-12 mb-3">
                            <label for="comments" class="form-label">Comments</label>
                            <textarea class="form-control" id="comments" name="comments" rows="3" 
                                      placeholder="Any additional notes or comments..."></textarea>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="col-12">
                            <hr>
                            <div class="d-flex justify-content-end">
                                <a href="{% url 'inventory:transaction_list' %}" class="btn btn-secondary me-2">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>Create Transaction
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Handle transaction type changes
    $('#transaction_type').change(function() {
        var transactionType = $(this).val();
        
        // Show/hide supplier section for incoming transactions
        if (transactionType && transactionType.startsWith('RCV')) {
            $('#supplier_section').show();
            $('#recipient_section').hide();
            $('#invoice_section').show();
            $('#invoice_date_section').show();
        } else if (transactionType && (transactionType.startsWith('SHIP') || transactionType.startsWith('ISS'))) {
            $('#supplier_section').hide();
            $('#recipient_section').show();
            $('#invoice_section').hide();
            $('#invoice_date_section').hide();
        } else {
            $('#supplier_section').hide();
            $('#recipient_section').hide();
            $('#invoice_section').hide();
            $('#invoice_date_section').hide();
        }
    });

    // Handle item selection to auto-fill unit
    $('#item_code').change(function() {
        var selectedOption = $(this).find('option:selected');
        var uom = selectedOption.data('uom');
        if (uom) {
            $('#unit').val(uom);
        }
    });

    // Handle storage zone changes to load locations
    $('#storage_zone').change(function() {
        var zoneId = $(this).val();
        if (zoneId) {
            $.get(`/inventory/api/storage-zones/${zoneId}/locations/`, function(data) {
                var locationSelect = $('#storage_location');
                locationSelect.empty();
                locationSelect.append('<option value="">Select Storage Location</option>');
                
                data.locations.forEach(function(location) {
                    locationSelect.append(`<option value="${location.id}">${location.name}</option>`);
                });
            });
        } else {
            $('#storage_location').empty().append('<option value="">Select Storage Location</option>');
        }
    });

    // Form validation
    $('#transactionForm').submit(function(e) {
        var transactionType = $('#transaction_type').val();
        var itemCode = $('#item_code').val();
        var quantity = $('#quantity').val();
        var unit = $('#unit').val();

        if (!transactionType || !itemCode || !quantity || !unit) {
            e.preventDefault();
            alert('Please fill in all required fields.');
            return false;
        }

        if (parseFloat(quantity) <= 0) {
            e.preventDefault();
            alert('Quantity must be greater than 0.');
            return false;
        }
    });
});
</script>
{% endblock %} 